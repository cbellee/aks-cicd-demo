# build.yaml

parameters:
  - name: vmImage
    default: 'ubuntu-latest'
    type: string
  - name: poolName
    default: 'Azure Pipelines'
    type: string
  - name: azureServiceConnection
    type: string

stages:
  - stage: Build
    jobs:
    - job: Build
      pool: 
        name: ${{parameters.poolName}}
        vmImage: ${{parameters.vmImage}}
      steps:
        - checkout: self
          clean: true
          persistCredentials: true
        - task: AzurePowerShell@5
          displayName: 'Lint Bicep files'
          inputs:
            azureSubscription: $(azureServiceConnection)
            ScriptType: InlineScript
            azurePowerShellVersion: LatestVersion
            pwsh: true
            FailOnStandardError: true
            Inline: |
              Get-ChildItem -Path ./iac -Filter *.bicep | Foreach-Object {
                Write-Host "Building Bicep main file $($_.FullName)"
                az bicep build --file $_.FullName --only-show-errors
              }

              Get-ChildItem -Path ./iac/modules -Filter *.bicep | Foreach-Object {
                Write-Host "Building Bicep module file $($_.FullName)"
                az bicep build --file $_.FullName --only-show-errors
              }
        - task: CopyFiles@2
          displayName: 'Copy Templates to Artifact Staging Directory'
          inputs:
            SourceFolder: '$(System.DefaultWorkingDirectory)/iac'
            TargetFolder: '$(Build.ArtifactStagingDirectory)'
          condition: succeededOrFailed()
        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifact: drop'
          condition: succeededOrFailed()